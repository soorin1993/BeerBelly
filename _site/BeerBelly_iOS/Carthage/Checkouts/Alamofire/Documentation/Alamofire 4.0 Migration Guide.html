<h1 id="alamofire-40-migration-guide">Alamofire 4.0 Migration Guide</h1>

<p>Alamofire 4.0 is the latest major release of Alamofire, an HTTP networking library for iOS, tvOS, macOS and watchOS written in Swift. As a major release, following Semantic Versioning conventions, 4.0 introduces API-breaking changes.</p>

<p>This guide is provided in order to ease the transition of existing applications using Alamofire 3.x to the latest APIs, as well as explain the design and structure of new and updated functionality.</p>

<ul>
  <li><a href="#requirements">Requirements</a></li>
  <li><a href="#benefits-of-upgrading">Benefits of Upgrading</a></li>
  <li><a href="#breaking-api-changes">Breaking API Changes</a>
    <ul>
      <li><a href="#namespace-changes">Namespace Changes</a></li>
      <li><a href="#making-requests">Making Requests</a></li>
      <li><a href="#urlstringconvertible">URLStringConvertible</a></li>
      <li><a href="#urlrequestconvertible">URLRequestConvertible</a></li>
    </ul>
  </li>
  <li><a href="#new-features">New Features</a>
    <ul>
      <li><a href="#request-adapter">Request Adapter</a></li>
      <li><a href="#request-retrier">Request Retrier</a></li>
      <li><a href="#task-metrics">Task Metrics</a></li>
    </ul>
  </li>
  <li><a href="#updated-features">Updated Features</a>
    <ul>
      <li><a href="#errors">Errors</a></li>
      <li><a href="#parameter-encoding-protocol">Parameter Encoding Protocol</a></li>
      <li><a href="#request-subclasses">Request Subclasses</a></li>
      <li><a href="#response-validation">Response Validation</a></li>
      <li><a href="#response-serializers">Response Serializers</a></li>
    </ul>
  </li>
</ul>

<h2 id="requirements">Requirements</h2>

<ul>
  <li>iOS 8.0+, macOS 10.10.0+, tvOS 9.0+ and watchOS 2.0+</li>
  <li>Xcode 8.1+</li>
  <li>Swift 3.0+</li>
</ul>

<p>For those of you that would like to use Alamofire on iOS 8 or macOS 10.9, please use the latest tagged 3.x release which supports both Swift 2.2 and 2.3.</p>

<h2 id="benefits-of-upgrading">Benefits of Upgrading</h2>

<ul>
  <li><strong>Complete Swift 3 Compatibility:</strong> includes the full adoption of the new <a href="https://swift.org/documentation/api-design-guidelines/">API Design Guidelines</a>.</li>
  <li><strong>New Error System:</strong> uses a new <code class="highlighter-rouge">AFError</code> type to adhere to the new pattern proposed in <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0112-nserror-bridging.md">SE-0112</a>.</li>
  <li><strong>New RequestAdapter Protocol:</strong> allows inspection and adaptation of every <code class="highlighter-rouge">URLRequest</code> before instantiating a <code class="highlighter-rouge">Request</code> allowing for easy modification of properties like the <code class="highlighter-rouge">Authorization</code> header.</li>
  <li><strong>New RequestRetrier Protocol:</strong> allows you to inspect and retry any failed <code class="highlighter-rouge">Request</code> if necessary allowing you to build custom authentication solutions (OAuth1, OAuth2, xAuth, Basic Auth, etc.) around a set of requests.</li>
  <li><strong>New Parameter Encoding Protocol:</strong> replaces the <code class="highlighter-rouge">ParameterEncoding</code> enumeration allowing for easier extension and customization and also throws errors on failure instead of returning a tuple.</li>
  <li><strong>New Request Types:</strong> include <code class="highlighter-rouge">DataRequest</code>, <code class="highlighter-rouge">DownloadRequest</code>, <code class="highlighter-rouge">UploadRequest</code> and <code class="highlighter-rouge">StreamRequest</code> that implement specialized progress, validation and serialization APIs and behaviors per <code class="highlighter-rouge">Request</code> type.</li>
  <li><strong>New Progress APIs:</strong> include <code class="highlighter-rouge">downloadProgress</code> and <code class="highlighter-rouge">uploadProgress</code> APIs supporting both <code class="highlighter-rouge">Progress</code> and <code class="highlighter-rouge">Int64</code> types and called on a specified dispatch queue defaulting to <code class="highlighter-rouge">.main</code>.</li>
  <li><strong>Enhanced Response Validation:</strong> now includes the <code class="highlighter-rouge">data</code> or <code class="highlighter-rouge">temporaryURL</code> and <code class="highlighter-rouge">destinationURL</code> allowing inline closures to parse the server data for error messages if validation failed.</li>
  <li><strong>New Download Destinations:</strong> allow you to have full control over the move operation on the file system by disabling it, removing a previous file and creating intermediate directories.</li>
  <li><strong>New Response Types:</strong> unify response API signatures and expose <code class="highlighter-rouge">temporaryURL</code> and <code class="highlighter-rouge">downloadURL</code> properties for downloads and the all new task metrics on newer platforms.</li>
</ul>

<hr />

<h2 id="breaking-api-changes">Breaking API Changes</h2>

<p>Alamofire 4 has fully adopted all the new Swift 3 changes and conventions, including the new <a href="https://swift.org/documentation/api-design-guidelines/">API Design Guidelines</a>. Because of this, almost every API in Alamofire has been modified in some way. We can’t possibly document every single change, so we’re going to attempt to identify the most common APIs and how they have changed to help you through those sometimes less than helpful compiler errors.</p>

<h3 id="namespace-changes">Namespace Changes</h3>

<p>Some of the common classes have been moved into the global namespace to make them a bit easier to work with and to make them first class types.</p>

<ul>
  <li><code class="highlighter-rouge">Manager</code> is now <code class="highlighter-rouge">SessionManager</code></li>
  <li><code class="highlighter-rouge">Request.TaskDelegate</code> is now <code class="highlighter-rouge">TaskDelegate</code></li>
  <li><code class="highlighter-rouge">Request.DataTaskDelegate</code> is now <code class="highlighter-rouge">DataTaskDelegate</code></li>
  <li><code class="highlighter-rouge">Request.DownloadTaskDelegate</code> is now <code class="highlighter-rouge">DownloadTaskDelegate</code></li>
  <li><code class="highlighter-rouge">Request.UploadTaskDelegate</code> is now <code class="highlighter-rouge">UploadTaskDelegate</code></li>
</ul>

<p>We’ve also reorganized the file structure and organization patterns significantly to make it easier to follow the code. We hope that this will encourage more users to get to know the internal structure and implementation of Alamofire. Knowledge is power.</p>

<h3 id="making-requests">Making Requests</h3>

<p>Since making requests is certainly the most common operation in Alamofire, here are some examples of Alamofire 3.x requests compared to their new equivalents in Alamofire 4.</p>

<h4 id="data-request---simple-with-url-string">Data Request - Simple with URL string</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// Alamofire 3</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="o">.</span><span class="kt">GET</span><span class="p">,</span> <span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Alamofire 4</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span> <span class="c1">// method defaults to `.get`</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="data-request---complex-with-url-string">Data Request - Complex with URL string</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// Alamofire 3</span>
<span class="k">let</span> <span class="nv">parameters</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">AnyObject</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"foo"</span><span class="p">:</span> <span class="s">"bar"</span><span class="p">]</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="o">.</span><span class="kt">GET</span><span class="p">,</span> <span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="o">.</span><span class="kt">JSON</span><span class="p">)</span>
	<span class="o">.</span><span class="n">progress</span> <span class="p">{</span> <span class="n">bytesRead</span><span class="p">,</span> <span class="n">totalBytesRead</span><span class="p">,</span> <span class="n">totalBytesExpectedToRead</span> <span class="k">in</span>
		<span class="nf">print</span><span class="p">(</span><span class="s">"Bytes: </span><span class="se">\(</span><span class="n">bytesRead</span><span class="se">)</span><span class="s">, Total Bytes: </span><span class="se">\(</span><span class="n">totalBytesRead</span><span class="se">)</span><span class="s">, Total Bytes Expected: </span><span class="se">\(</span><span class="n">totalBytesExpectedToRead</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">validate</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span> <span class="k">in</span>
		<span class="c1">// Custom evaluation closure (no access to server data)</span>
	    <span class="k">return</span> <span class="o">.</span><span class="n">success</span>
	<span class="p">}</span>
    <span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
		<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
	<span class="p">}</span>

<span class="c1">// Alamofire 4</span>
<span class="k">let</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s">"foo"</span><span class="p">:</span> <span class="s">"bar"</span><span class="p">]</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">method</span><span class="p">:</span> <span class="o">.</span><span class="k">get</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">JSONEncoding</span><span class="o">.</span><span class="k">default</span><span class="p">)</span>
	<span class="o">.</span><span class="nf">downloadProgress</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">utility</span><span class="p">))</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
		<span class="nf">print</span><span class="p">(</span><span class="s">"Progress: </span><span class="se">\(</span><span class="n">progress</span><span class="o">.</span><span class="n">fractionCompleted</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">validate</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">data</span> <span class="k">in</span>
		<span class="c1">// Custom evaluation closure now includes data (allows you to parse data to dig out error messages if necessary)</span>
	    <span class="k">return</span> <span class="o">.</span><span class="n">success</span>
	<span class="p">}</span>
    <span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
		<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
	<span class="p">}</span>
</code></pre>
</div>

<h4 id="download-request---simple-with-url-string">Download Request - Simple with URL string</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// Alamofire 3</span>
<span class="k">let</span> <span class="nv">destination</span> <span class="o">=</span> <span class="kt">Request</span><span class="o">.</span><span class="nf">suggestedDownloadDestination</span><span class="p">()</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="o">.</span><span class="kt">GET</span><span class="p">,</span> <span class="n">urlString</span><span class="p">,</span> <span class="nv">destination</span><span class="p">:</span> <span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
	<span class="c1">// What is fileURL...not easy to get</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Alamofire 4</span>
<span class="k">let</span> <span class="nv">destination</span> <span class="o">=</span> <span class="kt">Request</span><span class="o">.</span><span class="nf">suggestedDownloadDestination</span><span class="p">()</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span> <span class="c1">// method defaults to `.get`</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
	<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">temporaryURL</span><span class="p">)</span>
	<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">destinationURL</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="download-request---simple-with-url-request">Download Request - Simple with URL request</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// Alamofire 3</span>
<span class="k">let</span> <span class="nv">destination</span> <span class="o">=</span> <span class="kt">Request</span><span class="o">.</span><span class="nf">suggestedDownloadDestination</span><span class="p">()</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="n">urlRequest</span><span class="p">,</span> <span class="nv">destination</span><span class="p">:</span> <span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="nf">validate</span><span class="p">()</span><span class="o">.</span><span class="n">responseData</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
	<span class="c1">// What is fileURL...not easy to get</span>
	<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Alamofire 4</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="n">urlRequest</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="nf">validate</span><span class="p">()</span><span class="o">.</span><span class="n">responseData</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
	<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
	<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">temporaryURL</span><span class="p">)</span>
	<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">destinationURL</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="download-request---complex-with-url-string">Download Request - Complex with URL string</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// Alamofire 3</span>
<span class="k">let</span> <span class="nv">fileURL</span><span class="p">:</span> <span class="kt">NSURL</span>
<span class="k">let</span> <span class="nv">destination</span><span class="p">:</span> <span class="kt">Request</span><span class="o">.</span><span class="kt">DownloadFileDestination</span> <span class="o">=</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="k">in</span> <span class="n">fileURL</span> <span class="p">}</span>
<span class="k">let</span> <span class="nv">parameters</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">AnyObject</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"foo"</span><span class="p">:</span> <span class="s">"bar"</span><span class="p">]</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="o">.</span><span class="kt">GET</span><span class="p">,</span> <span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="o">.</span><span class="kt">JSON</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">destination</span><span class="p">)</span>
	<span class="o">.</span><span class="n">progress</span> <span class="p">{</span> <span class="n">bytesRead</span><span class="p">,</span> <span class="n">totalBytesRead</span><span class="p">,</span> <span class="n">totalBytesExpectedToRead</span> <span class="k">in</span>
		<span class="nf">print</span><span class="p">(</span><span class="s">"Bytes: </span><span class="se">\(</span><span class="n">bytesRead</span><span class="se">)</span><span class="s">, Total Bytes: </span><span class="se">\(</span><span class="n">totalBytesRead</span><span class="se">)</span><span class="s">, Total Bytes Expected: </span><span class="se">\(</span><span class="n">totalBytesExpectedToRead</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">validate</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span> <span class="k">in</span>
		<span class="c1">// Custom evaluation implementation (no access to temporary or destination URLs)</span>
	    <span class="k">return</span> <span class="o">.</span><span class="n">success</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
		<span class="nf">print</span><span class="p">(</span><span class="n">fileURL</span><span class="p">)</span> <span class="c1">// Only accessible if captured in closure scope, not ideal</span>
		<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
	<span class="p">}</span>

<span class="c1">// Alamofire 4</span>
<span class="k">let</span> <span class="nv">fileURL</span><span class="p">:</span> <span class="kt">URL</span>
<span class="k">let</span> <span class="nv">destination</span><span class="p">:</span> <span class="kt">DownloadRequest</span><span class="o">.</span><span class="kt">DownloadFileDestination</span> <span class="o">=</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="k">in</span> 
	<span class="nf">return</span> <span class="p">(</span><span class="n">fileURL</span><span class="p">,</span> <span class="p">[</span><span class="o">.</span><span class="n">createIntermediateDirectories</span><span class="p">,</span> <span class="o">.</span><span class="n">removePreviousFile</span><span class="p">])</span> 
<span class="p">}</span>
<span class="k">let</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s">"foo"</span><span class="p">:</span> <span class="s">"bar"</span><span class="p">]</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">method</span><span class="p">:</span> <span class="o">.</span><span class="k">get</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">JSONEncoding</span><span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">destination</span><span class="p">)</span>
	<span class="o">.</span><span class="nf">downloadProgress</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">utility</span><span class="p">))</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
		<span class="nf">print</span><span class="p">(</span><span class="s">"Progress: </span><span class="se">\(</span><span class="n">progress</span><span class="o">.</span><span class="n">fractionCompleted</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">validate</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">temporaryURL</span><span class="p">,</span> <span class="n">destinationURL</span> <span class="k">in</span>
		<span class="c1">// Custom evaluation closure now includes file URLs (allows you to parse out error messages if necessary)</span>
	    <span class="k">return</span> <span class="o">.</span><span class="n">success</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
		<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
		<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">temporaryURL</span><span class="p">)</span>
		<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">destinationURL</span><span class="p">)</span>
	<span class="p">}</span>
</code></pre>
</div>

<h4 id="upload-request---simple-with-url-string">Upload Request - Simple with URL string</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// Alamofire 3</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">upload</span><span class="p">(</span><span class="o">.</span><span class="kt">POST</span><span class="p">,</span> <span class="n">urlString</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Alamofire 4</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span> <span class="c1">// method defaults to `.post`</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="upload-request---simple-with-url-request">Upload Request - Simple with URL request</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// Alamofire 3</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">urlRequest</span><span class="p">,</span> <span class="nv">file</span><span class="p">:</span> <span class="n">fileURL</span><span class="p">)</span><span class="o">.</span><span class="nf">validate</span><span class="p">()</span><span class="o">.</span><span class="n">responseData</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
	<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Alamofire 4</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">fileURL</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">urlRequest</span><span class="p">)</span><span class="o">.</span><span class="nf">validate</span><span class="p">()</span><span class="o">.</span><span class="n">responseData</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
	<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="upload-request---complex-with-url-string">Upload Request - Complex with URL string</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// Alamofire 3</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">upload</span><span class="p">(</span><span class="o">.</span><span class="kt">PUT</span><span class="p">,</span> <span class="n">urlString</span><span class="p">,</span> <span class="nv">file</span><span class="p">:</span> <span class="n">fileURL</span><span class="p">)</span>
	<span class="o">.</span><span class="n">progress</span> <span class="p">{</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">totalBytes</span><span class="p">,</span> <span class="n">totalBytesExpected</span> <span class="k">in</span>
		<span class="c1">// Are these for upload or for downloading the response?</span>
		<span class="nf">print</span><span class="p">(</span><span class="s">"Bytes: </span><span class="se">\(</span><span class="n">bytesRead</span><span class="se">)</span><span class="s">, Total Bytes: </span><span class="se">\(</span><span class="n">totalBytesRead</span><span class="se">)</span><span class="s">, Total Bytes Expected: </span><span class="se">\(</span><span class="n">totalBytesExpectedToRead</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">validate</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span> <span class="k">in</span>
		<span class="c1">// Custom evaluation implementation (no access to server data)</span>
	    <span class="k">return</span> <span class="o">.</span><span class="n">success</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
		<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
	<span class="p">}</span>

<span class="c1">// Alamofire 4</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">fileURL</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">urlString</span><span class="p">,</span> <span class="nv">method</span><span class="p">:</span> <span class="o">.</span><span class="n">put</span><span class="p">)</span>
	<span class="o">.</span><span class="nf">uploadProgress</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">utility</span><span class="p">))</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
		<span class="nf">print</span><span class="p">(</span><span class="s">"Upload Progress: </span><span class="se">\(</span><span class="n">progress</span><span class="o">.</span><span class="n">fractionCompleted</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">downloadProgress</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span> <span class="c1">// called on main queue by default</span>
		<span class="nf">print</span><span class="p">(</span><span class="s">"Download Progress: </span><span class="se">\(</span><span class="n">progress</span><span class="o">.</span><span class="n">fractionCompleted</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">validate</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">data</span> <span class="k">in</span>
		<span class="c1">// Custom evaluation closure now includes data (allows you to parse data to dig out error messages if necessary)</span>
	    <span class="k">return</span> <span class="o">.</span><span class="n">success</span>
	<span class="p">}</span>
    <span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
		<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
	<span class="p">}</span>
</code></pre>
</div>

<p>As you can see, there are many breaking API changes, but the common APIs still adhere to the original design goals of being able to make complex requests through a single line of code in a concise, well defined manner.</p>

<h3 id="urlstringconvertible">URLStringConvertible</h3>

<p>There are two changes to the <code class="highlighter-rouge">URLStringConvertible</code> protocol that are worth noting.</p>

<h4 id="urlconvertible">URLConvertible</h4>

<p>The first MAJOR change worth noting on the <code class="highlighter-rouge">URLStringConvertible</code> is that it has been renamed to <code class="highlighter-rouge">URLConvertible</code>. In Alamofire 3.x, the <code class="highlighter-rouge">URLStringConvertible</code> was defined as:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">URLStringConvertible</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">URLString</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now in Alamofire 4, the <code class="highlighter-rouge">URLConvertible</code> protocol is defined as:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">URLConvertible</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">asURL</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URL</span>
<span class="p">}</span>
</code></pre>
</div>

<p>As you can see, the <code class="highlighter-rouge">URLString</code> property is completely gone and replaced by a new <code class="highlighter-rouge">asURL</code> method that throws. To explain, let’s first backup.</p>

<p>A VERY common problem in Alamofire is that users forget to percent escape their URL strings and Alamofire will crash. Up until now, we (the Alamofire team) have taken the stance that this is how Alamofire is designed and your URLs need to conform to <a href="https://tools.ietf.org/html/rfc2396">RFC 2396</a>. This is certainly not ideal for the community because we all would rather have Alamofire tell us that our URL was invalid rather than having it crash.</p>

<p>Now, back to the new <code class="highlighter-rouge">URLConvertible</code> protocol. The reason Alamofire was not previously able to safely handle invalid URL strings was, in fact, due to the lack of safety on <code class="highlighter-rouge">URLStringConvertible</code>. It’s not possible for Alamofire to know how to intelligently make an invalid URL string valid. Therefore, if the <code class="highlighter-rouge">URL</code> is unable to be created from the <code class="highlighter-rouge">URLConvertible</code>, an <code class="highlighter-rouge">AFError.invalidURL</code> error is thrown.</p>

<p>This change (along with many others) allows Alamofire to safely handle invalid URLs and report the error back in the response handlers.</p>

<h4 id="urlrequest-conformance">URLRequest Conformance</h4>

<p>The <code class="highlighter-rouge">URLRequest</code> no longer conforms to the <code class="highlighter-rouge">URLStringConvertible</code>, now <code class="highlighter-rouge">URLConvertible</code> protocol. This was always a bit of a stretch in the previous versions of Alamofire and wasn’t really necessary. It also had a high potential to introduce ambiguity into many Alamofire APIs. Because of these reasons, <code class="highlighter-rouge">URLRequest</code> no longer conforms to <code class="highlighter-rouge">URLStringConvertible</code> (now <code class="highlighter-rouge">URLConvertible</code>).</p>

<p>What this means in code is that you can no longer do the following:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">urlRequest</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://httpbin.org/get"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">urlString</span> <span class="o">=</span> <span class="n">urlRequest</span><span class="o">.</span><span class="n">urlString</span>
</code></pre>
</div>

<p>Instead, in Alamofire 4, you now have to do the following:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">urlRequest</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://httpbin.org/get"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">urlString</span> <span class="o">=</span> <span class="n">urlRequest</span><span class="o">.</span><span class="n">url</span><span class="p">?</span><span class="o">.</span><span class="n">absoluteString</span>
</code></pre>
</div>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1505">PR-1505</a> for more info.</p>
</blockquote>

<h3 id="urlrequestconvertible">URLRequestConvertible</h3>

<p>The <code class="highlighter-rouge">URLRequestConvertible</code> was susceptible to the same safety issues concerns as the <code class="highlighter-rouge">URLStringConvertible</code> in Alamofire 3.x. In Alamofire 3, the <code class="highlighter-rouge">URLRequestConvertible</code> was:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">URLRequestConvertible</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">URLRequest</span><span class="p">:</span> <span class="kt">URLRequest</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now, in Alamofire 4, it is:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">URLRequestConvertible</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">asURLRequest</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span>
<span class="p">}</span>
</code></pre>
</div>

<p>As you can see, the <code class="highlighter-rouge">URLRequest</code> property has been replaced by an <code class="highlighter-rouge">asURLRequest</code> method that throws when encountering an error generating the <code class="highlighter-rouge">URLRequest</code>.</p>

<p>The most likely place this will affect your code is in the <code class="highlighter-rouge">Router</code> design pattern. If you have a <code class="highlighter-rouge">Router</code>, it’s going to have to change, but for the better! You will now implement the <code class="highlighter-rouge">asURLRequest</code> method instead of the property which gives you the ability to throw an error if necessary. You no longer have to force unwrap unsafe data or parameters or wrap <code class="highlighter-rouge">ParameterEncoding</code> in a do-catch. Any error encountered in a <code class="highlighter-rouge">Router</code> can now be automatically handled by Alamofire.</p>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1505">PR-1505</a> for more info.</p>
</blockquote>

<hr />

<h2 id="new-features">New Features</h2>

<h3 id="request-adapter">Request Adapter</h3>

<p>The <code class="highlighter-rouge">RequestAdapter</code> protocol is a completely new feature in Alamofire 4.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">RequestAdapter</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">adapt</span><span class="p">(</span><span class="n">_</span> <span class="nv">urlRequest</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span>
<span class="p">}</span>
</code></pre>
</div>

<p>It allows each <code class="highlighter-rouge">Request</code> made on a <code class="highlighter-rouge">SessionManager</code> to be inspected and adapted before being created. One very specific way to use an adapter is to append an <code class="highlighter-rouge">Authorization</code> header to requests behind a certain type of authentication.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">AccessTokenAdapter</span><span class="p">:</span> <span class="kt">RequestAdapter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">accessToken</span><span class="p">:</span> <span class="kt">String</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">accessToken</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">accessToken</span> <span class="o">=</span> <span class="n">accessToken</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">adapt</span><span class="p">(</span><span class="n">_</span> <span class="nv">urlRequest</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">urlRequest</span> <span class="o">=</span> <span class="n">urlRequest</span>

        <span class="k">if</span> <span class="n">urlRequest</span><span class="o">.</span><span class="n">urlString</span><span class="o">.</span><span class="nf">hasPrefix</span><span class="p">(</span><span class="s">"https://httpbin.org"</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">urlRequest</span><span class="o">.</span><span class="nf">setValue</span><span class="p">(</span><span class="s">"Bearer "</span> <span class="o">+</span> <span class="n">accessToken</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Authorization"</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">urlRequest</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">sessionManager</span> <span class="o">=</span> <span class="kt">SessionManager</span><span class="p">()</span>
<span class="n">sessionManager</span><span class="o">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="kt">AccessTokenAdapter</span><span class="p">(</span><span class="nv">accessToken</span><span class="p">:</span> <span class="s">"1234"</span><span class="p">)</span>

<span class="n">sessionManager</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="s">"https://httpbin.org/get"</span><span class="p">)</span>
</code></pre>
</div>

<p>If an <code class="highlighter-rouge">Error</code> occurs during the adaptation process, it should be thrown and will be delivered in the response handler of the <code class="highlighter-rouge">Request</code>.</p>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1450">PR-1450</a> for more info.</p>
</blockquote>

<h3 id="request-retrier">Request Retrier</h3>

<p>The <code class="highlighter-rouge">RequestRetrier</code> is another brand new Alamofire 4 protocol.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">typealias</span> <span class="kt">RequestRetryCompletion</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span> <span class="nv">shouldRetry</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="n">_</span> <span class="nv">timeDelay</span><span class="p">:</span> <span class="kt">TimeInterval</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>

<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">RequestRetrier</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">should</span><span class="p">(</span><span class="n">_</span> <span class="nv">manager</span><span class="p">:</span> <span class="kt">SessionManager</span><span class="p">,</span> <span class="n">retry</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">,</span> <span class="n">with</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="kt">RequestRetryCompletion</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>It allows a <code class="highlighter-rouge">Request</code> that encountered an <code class="highlighter-rouge">Error</code> while being executed to be retried with an optional delay if specified.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">OAuth2Handler</span><span class="p">:</span> <span class="kt">RequestAdapter</span><span class="p">,</span> <span class="kt">RequestRetrier</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">should</span><span class="p">(</span><span class="n">_</span> <span class="nv">manager</span><span class="p">:</span> <span class="kt">SessionManager</span><span class="p">,</span> <span class="n">retry</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">,</span> <span class="n">with</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kt">RequestRetryCompletion</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">response</span> <span class="k">as?</span> <span class="kt">HTTPURLResponse</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">statusCode</span> <span class="o">==</span> <span class="mi">401</span> <span class="p">{</span>
            <span class="nf">completion</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1">// retry after 1 second</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">completion</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="c1">// don't retry</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">sessionManager</span> <span class="o">=</span> <span class="kt">SessionManager</span><span class="p">()</span>
<span class="n">sessionManager</span><span class="o">.</span><span class="n">retrier</span> <span class="o">=</span> <span class="kt">OAuth2Handler</span><span class="p">()</span>

<span class="n">sessionManager</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The retrier allows you to inspect the <code class="highlighter-rouge">Request</code> after it has completed and run all <code class="highlighter-rouge">Validation</code> closures to determine whether it should be retried. When using both the <code class="highlighter-rouge">RequestAdapter</code> and <code class="highlighter-rouge">RequestRetrier</code> protocols together, you can create credential refresh systems for OAuth1, OAuth2, Basic Auth and even exponential backoff retry policies. The possibilities are endless. For more information and examples on this topic, please refer to the README.</p>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1391">PR-1391</a> and <a href="https://github.com/Alamofire/Alamofire/pull/1450">PR-1450</a> for more info.</p>
</blockquote>

<h3 id="task-metrics">Task Metrics</h3>

<p>In iOS and tvOS 10 and macOS 10.12, Apple introduced the new <a href="https://developer.apple.com/reference/foundation/urlsessiontaskmetrics">URLSessionTaskMetrics</a> APIs. The task metrics encapsulate some fantastic statistical information about the request and response execution. The API is very similar to Alamofire’s <code class="highlighter-rouge">Timeline</code>, but provide many more statistics that Alamofire was unable to compute. We’re really excited about these APIs and have exposed them on each <code class="highlighter-rouge">Response</code> type meaning they couldn’t be easier to use.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
	<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>It’s important to note that these APIs are only available on iOS and tvOS 10+ and macOS 10.12+. Therefore, depending on your deployment target, you may need to use these inside availability checks:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="k">if</span> <span class="kd">#available(iOS 10.0, *)</span> <span class="p">{</span>
		<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1492">PR-1492</a> for more info.</p>
</blockquote>

<hr />

<h2 id="updated-features">Updated Features</h2>

<p>Alamofire 4 contains many new features and enhancements on existing ones. This section is designed to give a brief overview of the features and demonstrate their uses. For more information on each each, please refer to the linked pull request.</p>

<h3 id="errors">Errors</h3>

<p>Alamofire 4 contains a completely new error system that adopts the new pattern proposed in <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0112-nserror-bridging.md">SE-0112</a>. At the heart of the new error system is <code class="highlighter-rouge">AFError</code>, a new <code class="highlighter-rouge">Error</code> type enumeration backed by four main cases.</p>

<ul>
  <li><code class="highlighter-rouge">.invalidURL(url: URLConvertible)</code> - Returned when a <code class="highlighter-rouge">URLConvertible</code> type fails to create a valid <code class="highlighter-rouge">URL</code>.</li>
  <li><code class="highlighter-rouge">.parameterEncodingFailed(reason: ParameterEncodingFailureReason)</code> - Returned when a parameter encoding object throws an error during the encoding process.</li>
  <li><code class="highlighter-rouge">.multipartEncodingFailed(reason: MultipartEncodingFailureReason)</code> - Returned when some step in the multipart encoding process fails.</li>
  <li><code class="highlighter-rouge">.responseValidationFailed(reason: ResponseValidationFailureReason)</code> - Returned when a <code class="highlighter-rouge">validate()</code> call fails.</li>
  <li><code class="highlighter-rouge">.responseSerializationFailed(reason: ResponseSerializationFailureReason)</code> - Returned when a response serializer encounters an error in the serialization process.</li>
</ul>

<p>Each case contains a specific failure reason which is another nested enumeration with multiple cases that contain additional information about the exact type of error that occurred. What this ultimately means is that is is much easier in Alamofire to identify where an error came from and what to do about it.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">result</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">as?</span> <span class="kt">AFError</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">error</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">invalidURL</span><span class="p">(</span><span class="k">let</span> <span class="nv">url</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Invalid URL: </span><span class="se">\(</span><span class="n">url</span><span class="se">)</span><span class="s"> - </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">parameterEncodingFailed</span><span class="p">(</span><span class="k">let</span> <span class="nv">reason</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Parameter encoding failed: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Failure Reason: </span><span class="se">\(</span><span class="n">reason</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">multipartEncodingFailed</span><span class="p">(</span><span class="k">let</span> <span class="nv">reason</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Multipart encoding failed: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Failure Reason: </span><span class="se">\(</span><span class="n">reason</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">responseValidationFailed</span><span class="p">(</span><span class="k">let</span> <span class="nv">reason</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Response validation failed: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Failure Reason: </span><span class="se">\(</span><span class="n">reason</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

            <span class="k">switch</span> <span class="n">reason</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="n">dataFileNil</span><span class="p">,</span> <span class="o">.</span><span class="nv">dataFileReadFailed</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Downloaded file could not be read"</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">missingContentType</span><span class="p">(</span><span class="k">let</span> <span class="nv">acceptableContentTypes</span><span class="p">):</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Content Type Missing: </span><span class="se">\(</span><span class="n">acceptableContentTypes</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">unacceptableContentType</span><span class="p">(</span><span class="k">let</span> <span class="nv">acceptableContentTypes</span><span class="p">,</span> <span class="k">let</span> <span class="nv">responseContentType</span><span class="p">):</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Response content type: </span><span class="se">\(</span><span class="n">responseContentType</span><span class="se">)</span><span class="s"> was unacceptable: </span><span class="se">\(</span><span class="n">acceptableContentTypes</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">unacceptableStatusCode</span><span class="p">(</span><span class="k">let</span> <span class="nv">code</span><span class="p">):</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Response status code was unacceptable: </span><span class="se">\(</span><span class="n">code</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">responseSerializationFailed</span><span class="p">(</span><span class="k">let</span> <span class="nv">reason</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Response serialization failed: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Failure Reason: </span><span class="se">\(</span><span class="n">reason</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nf">print</span><span class="p">(</span><span class="s">"Underlying error: </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">underlyingError</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="k">as?</span> <span class="kt">URLError</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"URLError occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Unknown error: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This new design allows you to drill down into errors as deep as you may need to in order to figure out the best way to proceed. It also frees developers from the burden of having to deal with <code class="highlighter-rouge">NSError</code> types everywhere. By switching to our own custom <code class="highlighter-rouge">Error</code> type in Alamofire, we’ve been able to simplify the <code class="highlighter-rouge">Result</code> and <code class="highlighter-rouge">Response</code> generic types to only require a single generic parameter. This simplifies the response serialization logic.</p>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1419">PR-1419</a> for more info.</p>
</blockquote>

<h3 id="parameter-encoding-protocol">Parameter Encoding Protocol</h3>

<p>The <code class="highlighter-rouge">ParameterEncoding</code> enumeration has served us well for over two years at this point. However, it had some limitations that we wanted to address in Alamofire 4.</p>

<ul>
  <li>The <code class="highlighter-rouge">.url</code> case has always been a bit confusing since it selects a destination based on the HTTP method.</li>
  <li>The <code class="highlighter-rouge">.urlEncodedInURL</code> case has always been an eye sore to work around the behavior of the <code class="highlighter-rouge">.url</code> case.</li>
  <li><code class="highlighter-rouge">.JSON</code> and <code class="highlighter-rouge">.PropertyList</code> encoding could not accept formatting or writing options.</li>
  <li>The <code class="highlighter-rouge">.Custom</code> encoding was a bit difficult for users to get the hang of.</li>
</ul>

<p>Because of these reasons, we decided to eliminate the enumeration altogether in Alamofire 4! Now, <code class="highlighter-rouge">ParameterEncoding</code> is a protocol backed by three concrete <code class="highlighter-rouge">URLEncoding</code>, <code class="highlighter-rouge">JSONEncoding</code> and <code class="highlighter-rouge">PropertyList</code> encoding structs with a new <code class="highlighter-rouge">Parameters</code> typealias for creating your parameter dictionaries.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">typealias</span> <span class="kt">Parameters</span> <span class="o">=</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span>

<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">ParameterEncoding</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">_</span> <span class="nv">urlRequest</span><span class="p">:</span> <span class="kt">URLRequestConvertible</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span><span class="p">?)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="url-encoding">URL Encoding</h4>

<p>The new <code class="highlighter-rouge">URLEncoding</code> struct contains a <code class="highlighter-rouge">Destination</code> enumeration supporting three types of destinations:</p>

<ul>
  <li><code class="highlighter-rouge">.methodDependent</code> - Applies encoded query string result to existing query string for <code class="highlighter-rouge">GET</code>, <code class="highlighter-rouge">HEAD</code> and <code class="highlighter-rouge">DELETE</code> requests and sets as the HTTP body for requests with any other HTTP method.</li>
  <li><code class="highlighter-rouge">.queryString</code> - Sets or appends encoded query string result to existing query string.</li>
  <li><code class="highlighter-rouge">.httpBody</code> - Sets encoded query string result as the HTTP body of the URL request.</li>
</ul>

<p>These destinations make it much easier to control where the parameters are encoded onto the <code class="highlighter-rouge">URLRequest</code>. Creating requests still uses the same signature as before in regards to parameter encoding and also has the same default behavior.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s">"foo"</span><span class="p">:</span> <span class="s">"bar"</span><span class="p">]</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">)</span> <span class="c1">// Encoding =&gt; URLEncoding(destination: .methodDependent)</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">URLEncoding</span><span class="p">(</span><span class="nv">destination</span><span class="p">:</span> <span class="o">.</span><span class="n">queryString</span><span class="p">))</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">URLEncoding</span><span class="p">(</span><span class="nv">destination</span><span class="p">:</span> <span class="o">.</span><span class="n">httpBody</span><span class="p">))</span>

<span class="c1">// Static convenience properties (we'd like to encourage everyone to use this more concise form)</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">URLEncoding</span><span class="o">.</span><span class="k">default</span><span class="p">)</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">URLEncoding</span><span class="o">.</span><span class="n">queryString</span><span class="p">)</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">URLEncoding</span><span class="o">.</span><span class="n">httpBody</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="json-encoding">JSON Encoding</h4>

<p>The new <code class="highlighter-rouge">JSONEncoding</code> struct exposes the ability to customize the JSON writing options.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s">"foo"</span><span class="p">:</span> <span class="s">"bar"</span><span class="p">]</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">JSONEncoding</span><span class="p">(</span><span class="nv">options</span><span class="p">:</span> <span class="p">[]))</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">JSONEncoding</span><span class="p">(</span><span class="nv">options</span><span class="p">:</span> <span class="o">.</span><span class="n">prettyPrinted</span><span class="p">))</span>

<span class="c1">// Static convenience properties (we'd like to encourage everyone to use this more concise form)</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">JSONEncoding</span><span class="o">.</span><span class="k">default</span><span class="p">)</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">JSONEncoding</span><span class="o">.</span><span class="n">prettyPrinted</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="property-list-encoding">Property List Encoding</h4>

<p>The new <code class="highlighter-rouge">PropertyListEncoding</code> struct allows customizing the plist format and write options.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">parameters</span><span class="p">:</span> <span class="kt">Parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s">"foo"</span><span class="p">:</span> <span class="s">"bar"</span><span class="p">]</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">PropertyListEncoding</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="o">.</span><span class="n">xml</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">PropertyListEncoding</span><span class="p">(</span><span class="nv">format</span><span class="p">:</span> <span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1">// Static convenience properties (we'd like to encourage everyone to use this more concise form)</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">PropertyListEncoding</span><span class="o">.</span><span class="n">xml</span><span class="p">)</span>
<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">PropertyListEncoding</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="custom-encoding">Custom Encoding</h4>

<p>Creating a custom custom <code class="highlighter-rouge">ParameterEncoding</code> is now as simple as implementing the protocol. For more examples on how to do this, please refer to the README.</p>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1465">PR-1465</a> for more info.</p>
</blockquote>

<h3 id="request-subclasses">Request Subclasses</h3>

<p>In Alamofire 4, the <code class="highlighter-rouge">request</code>, <code class="highlighter-rouge">download</code>, <code class="highlighter-rouge">upload</code> and <code class="highlighter-rouge">stream</code> APIs no longer return a <code class="highlighter-rouge">Request</code>. Instead, they return a specific type of <code class="highlighter-rouge">Request</code> subclass. There were several motivating factors and community questions that led us to making this change:</p>

<ul>
  <li><strong>Progress:</strong> The behavior of the <code class="highlighter-rouge">progress</code> method was confusing for upload requests.
    <ul>
      <li>What does <code class="highlighter-rouge">progress</code> report on an upload <code class="highlighter-rouge">Request</code>? The progress of the upload? The progress of the response download?</li>
      <li>If it reports both, how do you know if or when it switches?</li>
    </ul>
  </li>
  <li><strong>Response Serializers:</strong> The response serializers were designed for data and upload requests, not download or stream requests.
    <ul>
      <li>How do you access the fileURL when a download is complete?</li>
      <li>What would <code class="highlighter-rouge">responseData</code>, <code class="highlighter-rouge">responseString</code> or <code class="highlighter-rouge">responseJSON</code> do for a download request? Stream request?</li>
    </ul>
  </li>
</ul>

<p>At a high level, Alamofire 4 now has four <code class="highlighter-rouge">Request</code> subclasses that each support their own custom chained APIs. This allows each subclass to create extensions tailored to that specific type of request.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="n">open</span> <span class="kd">class</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="c1">// Contains common properties, authentication and state methods as well as</span>
    <span class="c1">// CustomStringConvertible and CustomDebugStringConvertible conformance</span>
<span class="p">}</span>

<span class="n">open</span> <span class="kd">class</span> <span class="kt">DataRequest</span><span class="p">:</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="c1">// Contains stream (not to be confused with StreamRequest) and download progress methods.</span>
<span class="p">}</span>

<span class="n">open</span> <span class="kd">class</span> <span class="kt">DownloadRequest</span><span class="p">:</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="c1">// Contains download destination and options, resume data and download progress methods.</span>
<span class="p">}</span>

<span class="n">open</span> <span class="kd">class</span> <span class="kt">UploadRequest</span><span class="p">:</span> <span class="kt">DataRequest</span> <span class="p">{</span>
    <span class="c1">// Inherits all DataRequest APIs and also contains upload progress methods.</span>
<span class="p">}</span>

<span class="n">open</span> <span class="kd">class</span> <span class="kt">StreamRequest</span><span class="p">:</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="c1">// Only inherits Request APIs, there are no other custom APIs at this time.</span>
<span class="p">}</span>
</code></pre>
</div>

<p>By making this split, Alamofire 4 was able to create customized chaining APIs for each type of <code class="highlighter-rouge">Request</code>. This opened up all sorts of possibilities, but let’s take a moment to focus on what this change means in terms of progress reporting and download destinations.</p>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1455">PR-1455</a> for more info.</p>
</blockquote>

<h4 id="download-and-upload-progress">Download and Upload Progress</h4>

<p>The progress reporting system for data, download and upload requests has been completely redesigned. Each request type contains progress APIs for executing a closure during each progress update by returning the underlying <code class="highlighter-rouge">Progress</code> instance. The closure will be called on the specified queue that defaults to main.</p>

<p><strong>Data Request Progress</strong></p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span>
    <span class="o">.</span><span class="n">downloadProgress</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
        <span class="c1">// Called on main dispatch queue by default</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Download progress: </span><span class="se">\(</span><span class="n">progress</span><span class="o">.</span><span class="n">fractionCompleted</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre>
</div>

<p><strong>Download Request Progress</strong></p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">destination</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">downloadProgress</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">utility</span><span class="p">))</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
        <span class="c1">// Called on utility dispatch queue</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Download progress: </span><span class="se">\(</span><span class="n">progress</span><span class="o">.</span><span class="n">fractionCompleted</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre>
</div>

<p><strong>Upload Request Progress</strong></p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">urlString</span><span class="p">,</span> <span class="nv">withMethod</span><span class="p">:</span> <span class="o">.</span><span class="n">post</span><span class="p">)</span>
    <span class="o">.</span><span class="n">uploadProgress</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
        <span class="c1">// Called on main dispatch queue by default</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Upload progress: </span><span class="se">\(</span><span class="n">progress</span><span class="o">.</span><span class="n">fractionCompleted</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="n">downloadProgress</span> <span class="p">{</span> <span class="n">progress</span> <span class="k">in</span>
        <span class="c1">// Called on main dispatch queue by default</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Download progress: </span><span class="se">\(</span><span class="n">progress</span><span class="o">.</span><span class="n">fractionCompleted</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="n">responseData</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>It’s now easy to differentiate between upload and download progress for upload requests.</p>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1455">PR-1455</a> for more info.</p>
</blockquote>

<h4 id="download-file-destinations">Download File Destinations</h4>

<p>In Alamofire 3.x, successful download requests would always move the temporary file to a final destination URL provided by the <code class="highlighter-rouge">destination</code> closure. While this was a nice convenience, it had several limitations:</p>

<ul>
  <li><code class="highlighter-rouge">Forced</code> - The API forces you to provide a destination closure to move the file even if you have a valid use case for not moving it.</li>
  <li><code class="highlighter-rouge">Limiting</code> - There was no way to adjust the file system prior to moving the file.
    <ul>
      <li>What if you need to delete a pre-existing file at the destination URL before moving the temporary file?</li>
      <li>What if you need to create intermediate directories to the destination URL before moving the temporary file?</li>
    </ul>
  </li>
</ul>

<p>These limitations led to several enhancements in Alamofire 4. The first of which is the optionality of the destination closure. Now, by default, the <code class="highlighter-rouge">destination</code> closure is <code class="highlighter-rouge">nil</code> which means the file is not moved anywhere on the file system and the temporary URL is returned.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">responseData</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Temporary URL: </span><span class="se">\(</span><span class="n">response</span><span class="o">.</span><span class="n">temporaryURL</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<blockquote>
  <p>We’ll cover the <code class="highlighter-rouge">DownloadResponse</code> type in more detail in the <a href="#response-serializers">Reponse Serializers</a> section.</p>
</blockquote>

<h4 id="download-options">Download Options</h4>

<p>The other major change made was to add download options to the destination closure allowing more file system control over the move operation. To accomplish this, the <code class="highlighter-rouge">DownloadOptions</code> type was created and added to the <code class="highlighter-rouge">DownloadFileDestination</code> closure.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">typealias</span> <span class="kt">DownloadFileDestination</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">_</span> <span class="nv">temporaryURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span>
    <span class="n">_</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">)</span>
    <span class="o">-&gt;</span> <span class="p">(</span><span class="nv">destinationURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kt">DownloadOptions</span><span class="p">)</span>
</code></pre>
</div>

<p>The two currently supported <code class="highlighter-rouge">DownloadOptions</code> are:</p>

<ul>
  <li><code class="highlighter-rouge">.createIntermediateDirectories</code> - Creates intermediate directories for the destination URL if specified.</li>
  <li><code class="highlighter-rouge">.removePreviousFile</code> - Removes a previous file from the destination URL if specified.</li>
</ul>

<p>They can then be used as follows:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">destination</span><span class="p">:</span> <span class="kt">DownloadRequest</span><span class="o">.</span><span class="kt">DownloadFileDestination</span> <span class="o">=</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="k">in</span> 
    <span class="nf">return</span> <span class="p">(</span><span class="n">fileURL</span><span class="p">,</span> <span class="p">[</span><span class="o">.</span><span class="n">removePreviousFile</span><span class="p">,</span> <span class="o">.</span><span class="n">createIntermediateDirectories</span><span class="p">])</span> 
<span class="p">}</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>If an error occurs during the file system operations, the <code class="highlighter-rouge">error</code> on the <code class="highlighter-rouge">DownloadResponse</code> will be of type <code class="highlighter-rouge">URLError</code>.</p>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1462">PR-1462</a> for more info.</p>
</blockquote>

<h3 id="response-validation">Response Validation</h3>

<p>There were several opportunity areas for improving the response validation system in Alamofire 4. These areas included:</p>

<ul>
  <li>Exposing the underlying <code class="highlighter-rouge">data</code> to the <code class="highlighter-rouge">Validation</code> closure.</li>
  <li>Custom validation between different <code class="highlighter-rouge">Request</code> subclasses types allowing <code class="highlighter-rouge">temporaryURL</code> and <code class="highlighter-rouge">destinationURL</code> to be exposed for download requests.</li>
</ul>

<p>By creating <code class="highlighter-rouge">Request</code> subclasses, the validation closure typealias and request APIs were able to be tailored to each request type.</p>

<h4 id="data-request">Data Request</h4>

<p>The <code class="highlighter-rouge">Validation</code> closure exposed on the <code class="highlighter-rouge">DataRequest</code> (inherited by <code class="highlighter-rouge">UploadRequest</code>) is now as follows:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">DataRequest</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">typealias</span> <span class="kt">Validation</span> <span class="o">=</span> <span class="p">(</span><span class="kt">URLRequest</span><span class="p">?,</span> <span class="kt">HTTPURLResponse</span><span class="p">,</span> <span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">ValidationResult</span>
<span class="p">}</span>
</code></pre>
</div>

<p>By exposing the <code class="highlighter-rouge">Data?</code> property directly in the closure, you no longer have to write an extension on <code class="highlighter-rouge">Request</code> to access it. Now you can do something like this:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span>
    <span class="o">.</span><span class="n">validate</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">data</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">data</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">customError</span><span class="p">)</span> <span class="p">}</span>

        <span class="c1">// 1) Validate the response to make sure everything looks good</span>
        <span class="c1">// 2) If validation fails, you can now parse the error message out of the</span>
        <span class="c1">//    data if necessary and add that to your custom error if you wish.</span>

        <span class="k">return</span> <span class="o">.</span><span class="n">success</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre>
</div>

<h4 id="download-request">Download Request</h4>

<p>The <code class="highlighter-rouge">Validation</code> closure on the <code class="highlighter-rouge">DownloadRequest</code> is very similar to the <code class="highlighter-rouge">DataRequest</code> API, but tailored more to downloads.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">DownloadRequest</span> <span class="p">{</span>
	<span class="kd">public</span> <span class="kd">typealias</span> <span class="kt">Validation</span> <span class="o">=</span> <span class="p">(</span>
	    <span class="n">_</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">?,</span> 
	    <span class="n">_</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">,</span> 
	    <span class="n">_</span> <span class="nv">temporaryURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">?,</span> 
	    <span class="n">_</span> <span class="nv">destinationURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">?)</span> 
	    <span class="o">-&gt;</span> <span class="kt">ValidationResult</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">temporaryURL</code> and <code class="highlighter-rouge">destinationURL</code> parameters now allow you access the data returned by the server directly in an inline closure. This allows you to inspect the data inside the file if you’ve determined you need to in order to create a custom error.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span>
    <span class="o">.</span><span class="n">validate</span> <span class="p">{</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">temporaryURL</span><span class="p">,</span> <span class="n">destinationURL</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">fileURL</span> <span class="o">=</span> <span class="n">temporaryURL</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">customError</span><span class="p">)</span> <span class="p">}</span>

        <span class="k">do</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">_</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Data</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">fileURL</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">success</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">customError</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
        <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>By exposing the underlying server data directly to the inline closures, error messages embedded in those responses can be parsed out inside the <code class="highlighter-rouge">Validation</code> closure to create a custom error including the server error message. If the payload is the same schema as used in a response serializer closure, the response serializer could be called to parse out the error message rather than duplicating the logic. For an example of how to do this, please refer to the README.</p>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1461">PR-1461</a> for more info.</p>
</blockquote>

<h3 id="response-serializers">Response Serializers</h3>

<p>The response serialization system in Alamofire 3.x had several pretty severe limitations:</p>

<ul>
  <li>Response serialization APIs could be applied to download and stream requests but resulted in undefined behavior.
    <ul>
      <li>How do you access the fileURL when a download is complete?</li>
      <li>What would <code class="highlighter-rouge">responseData</code>, <code class="highlighter-rouge">responseString</code> or <code class="highlighter-rouge">responseJSON</code> do when chained onto a download request? A stream request?</li>
    </ul>
  </li>
  <li>The <code class="highlighter-rouge">response</code> API returned 4 parameters instead of an encapsulating <code class="highlighter-rouge">Response</code> type.
    <ul>
      <li>The biggest issue here is that any change to that API could not be done in a backwards compatible manner.</li>
      <li>Created confusion when switching between the serialized and unserialized APIs which led to difficult to debug compiler errors.</li>
    </ul>
  </li>
</ul>

<p>As you can see, there were some very strong limitations to this system in Alamofire 3.x. Therefore, in Alamofire 4, the <code class="highlighter-rouge">Request</code> type was first broken down into subclasses, which opened up the opportunity to create customized response serializers and APIs for specific types of requests. Before getting to far into response serializers, we should first walk through the new <code class="highlighter-rouge">Response</code> types.</p>

<h4 id="default-data-response">Default Data Response</h4>

<p>The <code class="highlighter-rouge">DefaultDataResponse</code> represents an unserialized server response. There’s no Alamofire processing that happens, it just collects all the response information from the <code class="highlighter-rouge">SessionDelegate</code> APIs and returns it in a simple struct.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">DefaultDataResponse</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?</span>
	<span class="kd">public</span> <span class="k">var</span> <span class="nv">metrics</span><span class="p">:</span> <span class="kt">URLSessionTaskMetrics</span><span class="p">?</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_metrics</span> <span class="k">as?</span> <span class="kt">URLSessionTaskMetrics</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This is the type of response you will get back from the <code class="highlighter-rouge">DataRequest.response</code> API.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">}</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="data-response">Data Response</h4>

<p>The generic <code class="highlighter-rouge">DataResponse</code> type is the same as the generic <code class="highlighter-rouge">Response</code> in Alamofire 3.x, but refactored and contains the new <code class="highlighter-rouge">metrics</code> property.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">DataResponse</span><span class="o">&lt;</span><span class="kt">Value</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Value</span><span class="o">&gt;</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">timeline</span><span class="p">:</span> <span class="kt">Timeline</span>
	<span class="kd">public</span> <span class="k">var</span> <span class="nv">metrics</span><span class="p">:</span> <span class="kt">URLSessionTaskMetrics</span><span class="p">?</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_metrics</span> <span class="k">as?</span> <span class="kt">URLSessionTaskMetrics</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>You still have access to the same response serialization APIs as before on the <code class="highlighter-rouge">DataRequest</code> and <code class="highlighter-rouge">UploadRequest</code> types.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">isSuccess</span><span class="p">)</span>
<span class="p">}</span>

<span class="kt">Alamofire</span><span class="o">.</span><span class="nf">upload</span><span class="p">(</span><span class="n">fileURL</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">responseData</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">isSuccess</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="default-download-response">Default Download Response</h4>

<p>Since downloads work differently than data and upload requests, Alamofire 4 contains custom download <code class="highlighter-rouge">Response</code> types tailored to their behavior. The <code class="highlighter-rouge">DefaultDownloadResponse</code> type represents an unserialized server response for a <code class="highlighter-rouge">DownloadRequest</code> that collects all the <code class="highlighter-rouge">SessionDelegate</code> information into a simple struct.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">DefaultDownloadResponse</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">HTTPURLResponse</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">temporaryURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">destinationURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">resumeData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?</span>
	<span class="kd">public</span> <span class="k">var</span> <span class="nv">metrics</span><span class="p">:</span> <span class="kt">URLSessionTaskMetrics</span><span class="p">?</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_metrics</span> <span class="k">as?</span> <span class="kt">URLSessionTaskMetrics</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">DefaultDownloadResponse</code> type is returned when using the new <code class="highlighter-rouge">DownloadRequest.response</code> API.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="n">urlString</span><span class="p">)</span><span class="o">.</span><span class="n">response</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">temporaryURL</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="download-response">Download Response</h4>

<p>The new generic <code class="highlighter-rouge">DownloadResponse</code> type is similar to the generic <code class="highlighter-rouge">DataResponse</code> type, but contains information tailored to download requests. The <code class="highlighter-rouge">DownloadResponse</code> type is returned when one of four new APIs exposed on the <code class="highlighter-rouge">DownloadRequest</code> type. These new APIs match the <code class="highlighter-rouge">DataRequest</code> ones, and provide the same functionality by loading the data from the underlying temporary or destination URL.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">Alamofire</span><span class="o">.</span><span class="nf">download</span><span class="p">(</span><span class="n">urlString</span><span class="p">,</span> <span class="nv">to</span><span class="p">:</span> <span class="n">destination</span><span class="p">)</span>
	<span class="o">.</span><span class="n">responseData</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    	<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">responseString</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    	<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">responseJSON</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    	<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">.</span><span class="n">responsePropertyList</span> <span class="p">{</span> <span class="n">response</span> <span class="k">in</span>
    	<span class="nf">debugPrint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
	<span class="p">}</span>
</code></pre>
</div>

<p>These new response serialization APIs make it MUCH easier to download a request to a file and serialize the response all in a single call.</p>

<h4 id="custom-response-serializers">Custom Response Serializers</h4>

<p>If you have created your own custom response serializers, you may want to extend support across both data and download requests similar to what we’ve done with the Alamofire response serializers. If you do decide to do this, take a close look at how Alamofire shares the response serializer implementation between both request types by moving the implementation to the <code class="highlighter-rouge">Request</code>. This allowed us to DRY up our logic to avoid duplication between types.</p>

<blockquote>
  <p>See <a href="https://github.com/Alamofire/Alamofire/pull/1457">PR-1457</a> for more info.</p>
</blockquote>
